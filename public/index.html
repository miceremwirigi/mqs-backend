<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script src="/script.js"></script>
    <title>MQS</title>
</head>
<body>
    <div class="header">
        <h1 class="title">MQS Inc.</h1>
        <h2 class="subtitle">Medical Equipment Service Sheduling</h2>
    </div>
    <div class="content">
        <div id="success-popup">Success</div>
        <div id="failed-popup">Failed</div>

        <table>
            <thead>
                <tr>
                    <th>Company Name</th>
                    <th>Location</th>
                    <th>Email Address</th>
                    <th>Last Service Date</th>
                    <th>Servicing Period (months)</th>
                    <th>Next Service Date</th>
                    <th>Service Status</th>
                </tr>
            </thead>
            <tbody id="customers-table-body">
                <tr>
                    <td>Equity Afia Donholm</td>
                    <td>Donholm</td>
                    <td>eadonholm@email.com</td>
                    <td>2025-05-01</td>
                    <td>1</td>
                    <td>2025-06-01</td>
                    <td>üü†</td>
                </tr><tr>
                    <td>RFH Kinoo</td>
                    <td>Kinoo</td>
                    <td>rfhkinoo@email.com</td>
                    <td>2025-01-01</td>
                    <td>2</td>
                    <td>2025-03-01</td>
                    <td>‚ùå</td>
                </tr>
                </tr>
                <tr>
                    <td>Modern Healthcare</td>
                    <td>Kintengela</td>
                    <td>mdhcare@email.com</td>
                    <td>2025-04-01</td>
                    <td>6</td>
                    <td>2025-03-01</td>
                    <td>‚úÖ</td>
                </tr>
                <!-- Entries will be dynamically added here -->
            </tbody>
        </table>
        <button id="show-form-button"  class="show-form-button" onclick="toggleFormVisibility(`add-entry-form`)">Add Entry</button>
        <script>
            
        </script>

        <form id="add-entry-form" class="add-content-form">
            <h3>Add New Customer</h3>
            <label for="company">Company Name:</label>
            <input type="text" id="company" name="company" required>
            <br>
            <label for="location">Location:</label>
            <input type="text" id="location" name="location" required>
            <br>
            <label for="email">Email Address:</label>
            <input type="email" id="email" name="email" required>
            <br>
            <label for="last-service-date">Last Service Date:</label>
            <input type="date" id="last-service-date" name="last-service-date" required>
            <br>
            <label for="servicing-period">Servicing Period (months):</label>
            <input type="number" id="servicing-period" name="servicing-period" required>
            <br>
            <button type="button" onclick="addCustomer()">Add Customer</button>
        </form>
        <script>
            // Function to add a new customer entry
            function addCustomer() {
                const company = document.getElementById('company').value;
                const location = document.getElementById('location').value;
                const email = document.getElementById('email').value;
                const lastServiceDate = document.getElementById('last-service-date').value;
                const servicingPeriod = parseInt(document.getElementById('servicing-period').value);

                if (company && location && email && lastServiceDate && servicingPeriod) {
                    const tableBody = document.getElementById('customers-table-body');
                    const newRow = document.createElement('tr');

                    const nextServiceDate = new Date(lastServiceDate);
                    nextServiceDate.setMonth(nextServiceDate.getMonth() + servicingPeriod);

                    const today = new Date();
                    const timeDiff = nextServiceDate - today;
                    const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                    const marker = daysDiff <= 0 ? '‚ùå' : daysDiff <= 30 ? 'üü†' : '‚úÖ';

                    newRow.innerHTML = `
                        <td>${company}</td>
                        <td>${location}</td>
                        <td>${email}</td>
                        <td>${lastServiceDate}</td>
                        <td>${servicingPeriod}</td>
                        <td>${nextServiceDate.toISOString().split('T')[0]}</td>
                        <td>${marker}</td>
                    `;

                    tableBody.appendChild(newRow);
                    document.getElementById('add-entry-form').reset();
                } else {
                    alert('Please fill in all fields.');
                }
            }

            // set form visibility toggle
            function toggleFormVisibility(formId) {
            const form = document.getElementById(formId);
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'flex' : 'none';
            form.scrollIntoView({ behavior: "smooth", block: "center" });

            }

            // Initially hide the input forms
            function hideInputForms(){
                var addForms = document.getElementsByClassName("add-content-form");
                for (var i=0; i<addForms.length; i++){
                    addForms[i].style.display = 'none';
                }
            }

            function showSuccessMessage() {
                const popup = document.getElementById('success-popup');
                popup.style.display = 'block';
                setTimeout(function() {
                    popup.style.display = 'none';
                }, 3000); // Message disappears after 3 seconds (3000 milliseconds)
            }

            function showFailedMessage() {
                const popup = document.getElementById('failed-popup');
                popup.style.display = 'block';
                setTimeout(function() {
                    popup.style.display = 'none';
                }, 3000); // Message disappears after 3 seconds (3000 milliseconds)
            }
        </script>

<!------------------ Hospitals Section ------------------>
        <table>
            <thead>
                <tr>
                    <th>Hospital Name</th>
                    <th>Location</th>
                    <th>Contact</th>
                </tr>
            </thead>
            <tbody id="hospitals-table-body">
            </tbody>
        </table>

        <button id="show-add-hospital-form-button" class="show-form-button" onclick="toggleFormVisibility(`add-hospital-form`)">Add Hospital</button>

        <!-- <iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe> -->
        <form id="add-hospital-form" class="add-content-form">
            <h3>Add New Hospital</h3>
            <label for="hospital-name">Hospital Name</label>
            <input type="text" id="hospital-name" name="name" required>
            <br>
            <label for="hospital-location">Location</label>
            <input type="text" id="hospital-location" name="location" required>
            <br>
            <label for="hospital-contact">Contact</label>
            <input type="text" id="hospital-contact" name="phone" required>
            <br>
            <button type="submit" onclick="handleAddHospitalsButton()">Add Hospital</button>
        </form>
        <script>
            var allHospitals = new Array
           hideInputForms(); // Hide all input forms in the page
           const hospitalsUrl = "/api/hospitals"; // endpoint to get hospitals list

           function getHospitals() {
            fetch(hospitalsUrl)
            .then(response => {
                if (!response.ok){
                    throw new Error(`HTTP Error: Status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                for (var i = 0; i < data.data.length; i++) {
                    const hospitalsTableBody = document.getElementById("hospitals-table-body")
                    // const newLink = document.createElement("a")
                    // newLink.href = `/api/hospitals/${data.data[i].id}`
                    const newRow = document.createElement("tr")
                    newRow.innerHTML = `                                                 
                            <td>${data.data[i].Name}</td>
                            <td>${data.data[i].Location}</td>
                            <td>${data.data[i].Phone}</td>      
                        `;
                    // make the rows clickable to redirect to each hospitals details
                    newRow.setAttribute("data-href", `/api/hospitals/details/${data.data[i].id}`)
                    newRow.addEventListener("click", function () {
                            window.location.href = this.dataset.href;
                        });
                    hospitalsTableBody.appendChild(newRow);
                    allHospitals = data.data
                }
            })
            .catch(error => {
                console.Error("error fetching hospitals");
            })
           }

            const form = document.getElementById("add-hospital-form");
            form.addEventListener( 'submit', async (event) => {
                    event.preventDefault();
                })

           async function handleAddHospitalsButton() {
                const form = document.getElementById("add-hospital-form");                
                const formData = new FormData(form);

                const jsonObject = Object.fromEntries(formData.entries())

                const jsonString = JSON.stringify(jsonObject);
                console.log(` form data ${jsonString}`);

                await fetch ("/api/hospitals",{
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonString,
                })
                .then(response => {
                    console.log(response)
                    if (!response.ok) {
                        throw new Error(`HTTP Error: Status ${response.status}`);
                    }
                    return response.json();
                })
                .then( body => {
                    showSuccessMessage();
                })
                .catch( error => {
                    console.error(`"error adding hospital: ${error}`);
                    showFailedMessage();
                })
                window.location.href = "/index.html";
                hideInputForms();
           }
           getHospitals();
        </script>

        <!------------------ ------------------------ ------------------>

        <!------------------ Engineers Section ------------------>
        <table>
            <thead>
                <tr>
                    <th>Engineer Name</th>
                    <th>Contact</th>
                </tr>
            </thead>
            <tbody id="engineers-table-body">
            </tbody>
        </table>

        <button id="show-add-engineer-form-button" class="show-form-button" onclick="toggleFormVisibility(`add-engineer-form`)">Add Engineer</button>

        <!-- <iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe> -->
        <form id="add-engineer-form" class="add-content-form">
            <h3>Add New Engineer</h3>
            <label for="engineer-name">Engineer Name</label>
            <input type="text" id="engineer-name" name="name" required>
            <br>
            <label for="engineer-contact">Contact</label>
            <input type="text" id="engineer-contact" name="contact" required>
            <br>
            <button type="submit" onclick="handleAddEngineersButton()">Add Engineer</button>
        </form>
        <script>
            var allEngineers = new Array
           hideInputForms(); // Hide all input forms in the page
           const engineersUrl = "/api/engineers"; // endpoint to get engineers list

           // Retreives all engineers from api and displays them in a table
           function getEngineers() {
            fetch(engineersUrl)
            .then(response => {
                if (!response.ok){
                    throw new Error(`HTTP Error: Status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                for (var i = 0; i < data.data.length; i++) {
                    const engineersTableBody = document.getElementById("engineers-table-body")
                    const newRow = document.createElement("tr")
                    newRow.innerHTML = `                                                 
                            <td>${data.data[i].name}</td>
                            <td>${data.data[i].contact}</td>      
                        `;
                    // make the rows clickable to redirect to each engineers details
                    newRow.setAttribute("data-href", `/api/engineers/details/${data.data[i].id}`)
                    newRow.addEventListener("click", function () {
                            window.location.href = this.dataset.href;
                        });
                    engineersTableBody.appendChild(newRow);                    
                }
                allEngineers = data.data
            })
            .catch(error => {
                console.Error("error fetching engineers");
            })
           }

            const engineersForm = document.getElementById("add-engineer-form");
            engineersForm.addEventListener( 'submit', async (event) => {
                    event.preventDefault();
                })

           async function handleAddEngineersButton() {
                const engineersForm = document.getElementById("add-engineer-form");                
                const formData = new FormData(engineersForm);

                const jsonObject = Object.fromEntries(formData.entries())

                const jsonString = JSON.stringify(jsonObject);
                console.log(` form data ${jsonString}`);

                await fetch ("/api/engineers",{
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonString,
                })
                .then(response => {
                    console.log(response.body)
                    if (!response.ok) {
                        throw new Error(`HTTP Error: Status ${response.status}`);
                    }
                    return response.json();
                })
                .then( body => {
                    showSuccessMessage();
                })
                .catch( error => {
                    console.error(`"error adding engineer: ${error}`);
                    showFailedMessage();
                })
                window.location.href = "/index.html";
                hideInputForms();
           }
           getEngineers();
        </script>

        <!------------------ ------------------------ ------------------>



        <!------------------ Equipments Section ------------------>
        <table>
            <thead>
                <tr>
                    <th>Equipment Name</th>
                    <th>Model</th>
                    <th>Servicing Interval</th>
                    <th>Hospital</th>
                </tr>
            </thead>
            <tbody id="equipments-table-body">
            </tbody>
        </table>

        <button id="show-add-equipment-form-button" class="show-form-button" onclick="toggleFormVisibility(`add-equipment-form`)">Add Equipment</button>

        <!-- <iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe> -->
        <form id="add-equipment-form" class="add-content-form">
            <h3>Add New Equipment</h3>
            <label for="equipment-name">Equipment Name</label>
            <input type="text" id="equipment-name" name="name" required>
            <br>
            <label for="equipment-model">Model</label>
            <input type="text" id="equipment-model" name="model" required>
            <br>
            <label for="equipment-servicing-period">Servicing Period</label>
            <input type="text" id="equipment-servicing-period" name="servicing_period" required>
            <br>
            <label for="equipment-hospital-id">Hospital</label>
            <select id="equipment-hospital-id" name="hospital_id" required>
            </select>
            <br>
            <button type="submit" onclick="handleAddEquipmentsButton()">Add Equipment</button>
        </form>
        <script>

            var allEquipments = new Array;
           hideInputForms(); // Hide all input forms in the page
           const equipmentsUrl = "/api/equipments"; // endpoint to get equipments list

           // Retreives all equipments from api and displays them in a table
           function getEquipments() {
            fetch(equipmentsUrl)
            .then(response => {
                if (!response.ok){
                    throw new Error(`HTTP Error: Status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                for (var i = 0; i < data.data.length; i++) {
                    const equipmentsTableBody = document.getElementById("equipments-table-body")
                    const newRow = document.createElement("tr")
                    newRow.innerHTML = `                                                 
                            <td>${data.data[i].Name}</td>
                            <td>${data.data[i].Model}</td>      
                            <td>${data.data[i].ServicingPeriod}</td>      
                            <td>${data.data[i].Hospital.Name}</td>      
                        `;
                    // make the rows clickable to redirect to each equipments details
                    newRow.setAttribute("data-href", `/api/equipments/details/${data.data[i].id}`)
                    newRow.addEventListener("click", function () {
                            window.location.href = this.dataset.href;
                        });
                    equipmentsTableBody.appendChild(newRow);
                }
                allEquipments = data.data
            })
            .catch(error => {
                console.Error("error fetching equipments");
            })
           }

            const equipmentsForm = document.getElementById("add-equipment-form");
            equipmentsForm.addEventListener( 'submit', async (event) => {
                    event.preventDefault();
                })

            const equipmentHospitalIDsSelect = document.getElementById("equipment-hospital-id");
            equipmentHospitalIDsSelect.addEventListener("focus", async (event) => {

                for (const index in allHospitals) {                    
                    if (Object.prototype.hasOwnProperty.call(allHospitals, index)) {
                        // const element = object[index];
                        newOption = document.createElement('option');
                        newOption.value = allHospitals[index].id;
                        newOption.innerHTML = `
                            ${allHospitals[index].Name}
                        `;
                    equipmentHospitalIDsSelect.appendChild(newOption);
                        
                    }
                }
            } )

           async function handleAddEquipmentsButton() {
                const equipmentsForm = document.getElementById("add-equipment-form");                
                const formData = new FormData(equipmentsForm);

                const jsonObject = Object.fromEntries(formData.entries())

                const jsonString = JSON.stringify(jsonObject);
                console.log(` form data ${jsonString}`);

                await fetch ("/api/equipments",{
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonString,
                })
                .then(response => {
                    console.log(response.body)
                    if (!response.ok) {
                        throw new Error(`HTTP Error: Status ${response.status}`);
                    }
                    return response.json();
                })
                .then( body => {
                    showSuccessMessage();
                })
                .catch( error => {
                    console.error(`"error adding equipment: ${error}`);
                    showFailedMessage();
                })
                window.location.href = "/index.html";
                hideInputForms();
           }
           getEquipments();
        </script>

        <!------------------ ------------------------ ------------------>

        <!------------------ Services Section ------------------>
        <table>
            <thead>
                <tr>
                    <th>Service Date</th>
                    <th>Servicing Equipment</th>
                    <th>Serviced By</th>
                </tr>
            </thead>
            <tbody id="services-table-body">
            </tbody>
        </table>

        <button id="show-add-service-form-button" class="show-form-button" onclick="toggleFormVisibility(`add-service-form`)">Add Service</button>

        <form id="add-service-form" class="add-content-form">
            <h3>Add New Service</h3>
            <label for="service-date">Service Date</label>
            <input type="date" id="service-date" name="date" required>
            <br>
            <label for="service-equipments">Equipments</label>
            <select id="service-equipments" name="equipments" required multiple>
            </select>
            <br>
            <label for="service-engineers">Serviced By</label>
            <select type="text" id="service-engineers" name="engineers" multiple>
            </select>
            <br>
            <button type="submit" onclick="handleAddServicesButton()">Add Service</button>
        </form>
        <script>
           hideInputForms(); // Hide all input forms in the page
           const servicesUrl = "/api/services"; // endpoint to get services list

           // Retreives all services from api and displays them in a table
           function getServices() {
            fetch(servicesUrl)
            .then(response => {
                if (!response.ok){
                    return response.text().then((text) =>{
                        throw new Error(`HTTP Error: Status ${response.status}: ${text}`);
                    })                    
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                for (var i = 0; i < data.data.length; i++) {
                    const servicesTableBody = document.getElementById("services-table-body");
                    const newRow = document.createElement("tr");
                    let listOfEquipments = ""
                    data.data[i].Equipments.forEach(equipment => {
                        listOfEquipments = listOfEquipments + equipment.Name + "-" + equipment.Hospital.Name + ", ";
                    });
                    let listOfEngineers = ""
                    data.data[i].Engineers.forEach(engineer => {
                        listOfEngineers = listOfEngineers + engineer.Name + ", ";
                    });
                    newRow.innerHTML = `                                                 
                            <td>${new Date(data.data[i].Date).toDateString()}</td>
                            <td>${listOfEquipments}</td>      
                            <td>${data.data[i].Engineers}</td>      
                        `;
                    // make the rows clickable to redirect to each services details
                    newRow.setAttribute("data-href", `/api/services/details/${data.data[i].id}`)
                    newRow.addEventListener("click", function () {
                            window.location.href = this.dataset.href;
                        });
                    servicesTableBody.appendChild(newRow);
                }
            })
            .catch(error => {
                console.Error("error fetching services:", error.message);
            })
           }

           // event to prevent form default submission
            const servicesForm = document.getElementById("add-service-form");
            servicesForm.addEventListener( 'submit', async (event) => {
                    event.preventDefault();
                })
       
            // Event to list available equipment options on the form
            const servicedEquipmentsIDsSelect = document.getElementById("service-equipments");
            servicedEquipmentsIDsSelect.addEventListener("focus", async (event) => {

                for (const index in allEquipments) {                    
                    if (Object.prototype.hasOwnProperty.call(allEquipments, index)) {
                        // const element = object[index];
                        newOption = document.createElement('option');
                        newOption.value = allEquipments[index].id;
                        newOption.innerHTML = `
                            ${allEquipments[index].Name} - ${allEquipments[index].Hospital.Name}
                        `;
                    servicedEquipmentsIDsSelect.appendChild(newOption);
                        
                    }
                }
            })

            // Event to list available engineer options on the form
            const serviceEngineersIDsSelect = document.getElementById("service-engineers");
            serviceEngineersIDsSelect.addEventListener("focus", async (event) => {

                for (const index in allEngineers) {                    
                    if (Object.prototype.hasOwnProperty.call(allEngineers, index)) {
                        // const element = object[index];
                        newOption = document.createElement('option');
                        newOption.value = allEngineers[index].id;
                        newOption.innerHTML = `
                            ${allEngineers[index].name}
                        `;
                    serviceEngineersIDsSelect.appendChild(newOption);
                        
                    }
                }
            })

           async function handleAddServicesButton() {
                const servicesForm = document.getElementById("add-service-form");                
                const formData = new FormData(servicesForm);

                // Handle equipments options selection in service form
                var selectedEquipmentOptions = [];
                var selectEquipmentElement = document.getElementById("service-equipments");
                for (var i = 0; i < selectEquipmentElement.options.length; i++) {
                    if (selectEquipmentElement.options[i].selected) {
                        selectedEquipmentOptions.push(selectEquipmentElement.options[i].value);
                    }
                }
                console.log(selectedEquipmentOptions)
                formData.set("equipments", selectedEquipmentOptions.join(','))

                // Handle engineer options selection in service form
                var selectedEngineerOptions = [];
                var selectEngineerElement = document.getElementById("service-engineers");
                for (var i = 0; i < selectEngineerElement.options.length; i++) {
                    if (selectEngineerElement.options[i].selected) {
                        selectedEngineerOptions.push(selectEngineerElement.options[i].value);
                    }
                }
                console.log(selectedEngineerOptions)
                formData.set("engineers", selectedEngineerOptions.join(','))

                const jsonObject = Object.fromEntries(formData.entries());
                jsonObject.date = new Date(jsonObject.date)

                const jsonString = JSON.stringify(jsonObject);
                console.log(` form data ${jsonString}`);

                await fetch ("/api/services",{
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonString,
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then((text) =>{
                            console.log (text);                     
                            throw new Error(`HTTP Error: Status ${response.status}, body: ${text}`);
                        })        
                    }
                    return response.json();
                })
                .then( body => {
                    showSuccessMessage();
                })
                .catch( error => {
                    console.error(`"error adding service: ${error} :`, error.message);
                    showFailedMessage();
                })
                // window.location.href = "/index.html";
                hideInputForms();
           }
           getServices();
        </script>

        <!------------------ ------------------------ ------------------>
        
        <p>For more information, please refer to the documentation.</p>
        <p>Version: 1.0.0</p>
    </div>

    <div class="footer">
        <p>&copy; 2025 MQS. All rights reserved.</p>
    </div>
</body>
<script src="/script.js"></script>
</html>